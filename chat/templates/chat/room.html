{% load static %}

<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <link href="{% static "chat/styles.css" %}" rel="stylesheet"/>
    <title>Chat</title>
  </head>
  <body>
    

    <div class="container">
      <div class="row clearfix">
          <div class="col-lg-12">
              <div class="card chat-app">
                  <div id="plist" class="people-list">
                      <div class="input-group">
                          <div class="input-group-prepend">
                              <span class="input-group-text"><i class="fa fa-search"></i></span>
                          </div>
                          <input type="text" class="form-control" placeholder="Search...">
                      </div>
                      <ul class="list-unstyled chat-list mt-2 mb-0">
                          <li class="clearfix">
                              <img src="https://bootdey.com/img/Content/avatar/avatar1.png" alt="avatar">
                              <div class="about">
                                  <div class="name">Vincent Porter</div>
                                  <div class="status"> <i class="fa fa-circle offline"></i> left 7 mins ago </div>                                            
                              </div>
                          </li>
                          <li class="clearfix active">
                              <img src="https://bootdey.com/img/Content/avatar/avatar2.png" alt="avatar">
                              <div class="about">
                                  <div class="name">Aiden Chavez</div>
                                  <div class="status"> <i class="fa fa-circle online"></i> online </div>
                              </div>
                          </li>
                          <li class="clearfix">
                              <img src="https://bootdey.com/img/Content/avatar/avatar3.png" alt="avatar">
                              <div class="about">
                                  <div class="name">Mike Thomas</div>
                                  <div class="status"> <i class="fa fa-circle online"></i> online </div>
                              </div>
                          </li>                                    
                          <li class="clearfix">
                              <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="avatar">
                              <div class="about">
                                  <div class="name">Christian Kelly</div>
                                  <div class="status"> <i class="fa fa-circle offline"></i> left 10 hours ago </div>
                              </div>
                          </li>
                          
                      </ul>
                  </div>
                  <div class="chat">
                      <div class="chat-header clearfix">
                          <div class="row">
                              <div class="col-lg-6">
                                  <div class="chat-about">
                                      <h3 class="m-b-0">{{ room_name }}</h3>
                                  </div>
                              </div>
                              <div class="col-lg-6 hidden-sm text-right">
                                  <a href="javascript:void(0);" class="btn btn-outline-primary"><i class="fa fa-image"></i></a>
                              </div>
                          </div>
                      </div>
                      <div class="chat-history">
                          <ul class="m-b-0", id="chat-log">
                          </ul>
                      </div>
                      <div class="chat-message clearfix">
                          <div class="input-group mb-0">
                              
                              <input type="text" id="chat-message-input" class="form-control" placeholder="Enter text here...">       
                              <div class="input-group-prepend">
                                <button id="chat-message-submit" class="submit">
                                <i class="fa fa-send"></i>
                                </button>
                            </div>                             
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      </div>

      <script src="{% static 'chat/reconnecting-websocket.js' %}"></script>
      <script>
        var roomName = {{ room_name }};
        var username = {{ username }};
    
        var chatSocket = new ReconnectingWebSocket(
            'ws://' + window.location.host +
            '/ws/chat/' + roomName + '/');
    
        chatSocket.onopen = function(e) {
          fetchMessages();
        }
    
        chatSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            if (data['command'] === 'messages') {
              for (let i=0; i < data['messages'].length; i++) {
                createMessage(data['messages'][i]);
              }
            } else if (data['command'] === 'new_message'){
              createMessage(data['message']);
            }
        };
    
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
    
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };
    
        document.querySelector('#chat-message-submit').onclick = function(e) {
            var messageInputDom = document.getElementById('chat-message-input');
            var message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'command': 'new_message',
                'message': message,
                'from': username
            }));
    
            messageInputDom.value = '';
        };
    
        function fetchMessages() {
          chatSocket.send(JSON.stringify({'command': 'fetch_messages' }));
        }

    
        function createMessage(data) {
          var author = data['author'];
          var created = data['created']
          var content = data['text']
          var msgListTag = document.createElement('li');
          var divTag = document.createElement('div');
          var divTag2 = document.createElement('div');
          var spanTag = document.createElement('div');

          msgListTag.className = "clearfix";
          spanTag.className = "message-data-time";
          spanTag.textContent = created;
          divTag.textContent = content;
          
          
          if (author === username) {
            divTag2.className = "message-data text-right"
            divTag.className = "message my-message float-right"
          } else {
            divTag2.className = "message-data"
            divTag.className = "message other-message"
          }
          divTag2.appendChild(spanTag)
          msgListTag.appendChild(divTag2);
          msgListTag.appendChild(divTag);
          document.querySelector('#chat-log').appendChild(msgListTag);
        }
      </script>
  </body>
</html>